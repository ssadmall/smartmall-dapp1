<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Smart Mall DApp</title>
  <base href="/smartmall-dapp1/">
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, doc, collection, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    // TODO: Thay th·∫ø b·∫±ng config c·ªßa b·∫°n
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
  </script>
  <style>
    body { background:#0a1a2f; color:#fff; font-family:Arial,sans-serif; margin:0; padding-bottom:60px; }
    #app { display: none; }
    nav { position:fixed; bottom:0; left:0; right:0; display:flex; background:#162447; border-top:2px solid #21e6c1; }
    .nav-btn { flex:1; padding:10px; text-align:center; color:#fff; cursor:pointer; }
    .nav-btn.active { background:#21e6c1; color:#0a1a2f; }
    section { display:none; padding:20px; margin-top:50px; }
    section.show { display:block; }
    button, input { width:100%; padding:8px; margin:6px 0; border:none; border-radius:4px; }
    button { background:#21e6c1; color:#0a1a2f; font-weight:bold; cursor:pointer; }
    .list-item { background:#1f4068; padding:10px; margin:6px 0; border-radius:4px; display:flex; justify-content:space-between; align-items:center; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
    .modal.show { display:flex; }
    .modal-content { background:#162447; padding:20px; border-radius:8px; width:90%; max-width:400px; }
    .close-btn { background:#d03232; color:#fff; margin-top:10px; }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <section id="login" class="show">
    <h2>üîë ƒêƒÉng nh·∫≠p</h2>
    <input id="usernameInput" placeholder="Username" />
    <button id="loginBtn">ƒêƒÉng nh·∫≠p</button>
  </section>
  <!-- APP -->
  <div id="app">
    <nav>
      <div id="tab-home" class="nav-btn active">Home</div>
      <div id="tab-session" class="nav-btn">Phi√™n</div>
      <div id="tab-nft" class="nav-btn">NFT</div>
      <div id="tab-wallet" class="nav-btn">V√≠</div>
      <div id="tab-profile" class="nav-btn">Profile</div>
    </nav>
    <section id="home">
      <h2>Ch√†o b·∫°n, <span id="labelUsername"></span></h2>
      <button id="btnRegister">ƒêƒÉng k√Ω phi√™n (20k)</button>
      <ul id="listSessions"></ul>
    </section>
    <section id="session">
      <h2>Danh s√°ch Phi√™n</h2>
      <ul id="sessionList"></ul>
    </section>
    <section id="nft">
      <h2>Marketplace NFT</h2>
      <ul id="productList"></ul>
    </section>
    <section id="wallet">
      <h2>V√≠ c·ªßa b·∫°n</h2>
      <p>S·ªë d∆∞: <span id="walletBalance"></span> SML</p>
      <button id="btnDeposit">N·∫°p v√≠</button>
      <button id="btnWithdraw">R√∫t v√≠</button>
      <ul id="walletHistory"></ul>
    </section>
    <section id="profile">
      <h2>Profile</h2>
      <p>Username: <span id="profileUsername"></span></p>
      <p>ƒêƒÉng k√Ω: <span id="countRegistrations"></span> l·∫ßn</p>
      <p>S·ªë NFT s·ªü h·ªØu: <span id="countNFT"></span></p>
    </section>
  </div>

  <!-- MODALS -->
  <div id="depositModal" class="modal">
    <div class="modal-content">
      <h3>N·∫°p v√≠</h3>
      <input id="inputDeposit" type="number" placeholder="S·ªë ti·ªÅn" />
      <button id="confirmDeposit">X√°c nh·∫≠n</button>
      <button id="closeDeposit" class="close-btn">ƒê√≥ng</button>
    </div>
  </div>
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <h3>R√∫t v√≠</h3>
      <input id="inputWithdraw" type="number" placeholder="S·ªë ti·ªÅn" />
      <button id="confirmWithdraw">X√°c nh·∫≠n</button>
      <button id="closeWithdraw" class="close-btn">ƒê√≥ng</button>
    </div>
  </div>
  <div id="sellModal" class="modal">
    <div class="modal-content">
      <h3>ƒêƒÉng b√°n NFT</h3>
      <input id="inputSellPrice" type="number" placeholder="Gi√° b√°n" />
      <button id="confirmSell">X√°c nh·∫≠n</button>
      <button id="closeSell" class="close-btn">ƒê√≥ng</button>
    </div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { doc, collection, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    const db = window.db;
    let currentUsername = "", state = { walletBalance: 0, registrations: [], userNFT: [], walletHistory: [] };

    // UI elements
    const loginSection = document.getElementById('login');
    const appDiv = document.getElementById('app');
    const tabs = document.querySelectorAll('.nav-btn');
    const sections = {
      home: document.getElementById('home'),
      session: document.getElementById('session'),
      nft: document.getElementById('nft'),
      wallet: document.getElementById('wallet'),
      profile: document.getElementById('profile')
    };
    const labelUsername = document.getElementById('labelUsername');
    const profileUsername = document.getElementById('profileUsername');
    const btnRegister = document.getElementById('btnRegister');
    const listSessions = document.getElementById('listSessions');
    const productList = document.getElementById('productList');
    const walletBalanceEl = document.getElementById('walletBalance');
    const walletHistoryEl = document.getElementById('walletHistory');
    const countRegs = document.getElementById('countRegistrations');
    const countNFT = document.getElementById('countNFT');
    const depositModal = document.getElementById('depositModal');
    const inputDeposit = document.getElementById('inputDeposit');
    const confirmDeposit = document.getElementById('confirmDeposit');
    const closeDeposit = document.getElementById('closeDeposit');
    const withdrawModal = document.getElementById('withdrawModal');
    const inputWithdraw = document.getElementById('inputWithdraw');
    const confirmWithdraw = document.getElementById('confirmWithdraw');
    const closeWithdraw = document.getElementById('closeWithdraw');
    const sellModal = document.getElementById('sellModal');
    const inputSellPrice = document.getElementById('inputSellPrice');
    const confirmSell = document.getElementById('confirmSell');
    const closeSell = document.getElementById('closeSell');

    // Chuy·ªÉn tab
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        Object.values(sections).forEach(s => s.classList.remove('show'));
        sections[tab.id.replace('tab-', '')].classList.add('show');
      });
    });

    // ƒêƒÉng nh·∫≠p & init real-time
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const u = document.getElementById('usernameInput').value.trim();
      if (!u) return alert('Nh·∫≠p username!');
      currentUsername = u; labelUsername.innerText = u; profileUsername.innerText = u;
      // ·∫®n login, hi·ªán app
      loginSection.classList.remove('show');
      appDiv.style.display = 'block';
      sections.home.classList.add('show');

      const userRef = doc(db, 'users', u);
      // L·∫Øng nghe user
      onSnapshot(userRef, snap => {
        if (snap.exists()) { state = { ...state, ...snap.data() }; updateUI(); }
      });
      const initial = await getDoc(userRef);
      if (!initial.exists()) {
        state.walletBalance = 1000000;
        await setDoc(userRef, state);
      }
      // L·∫Øng nghe products
      onSnapshot(collection(db, 'products'), snap => renderProducts(snap.docs));
    });

    // Render & actions
    function renderSessions(regs) {
      listSessions.innerHTML = '';
      (regs||[]).forEach(ts => {
        const li = document.createElement('li');
        li.textContent = new Date(ts).toLocaleString('vi-VN');
        listSessions.appendChild(li);
      });
    }
    function renderProducts(docs) {
      productList.innerHTML = '';
      docs.forEach(d => {
        const data = d.data();
        if (data.status === 'forSale') {
          const li = document.createElement('li'); li.className = 'list-item';
          const info = document.createElement('span'); info.textContent = `${data.name} - ${data.price} SML`;
          const btn = document.createElement('button'); btn.textContent = 'Mua'; btn.onclick = () => buyProduct(d.id);
          li.append(info, btn); productList.appendChild(li);
        }
      });
    }
    btnRegister.addEventListener('click', async () => {
      if (state.walletBalance < 20000) return alert('V√≠ kh√¥ng ƒë·ªß');
      await updateDoc(doc(db,'users',currentUsername),{
        walletBalance: state.walletBalance-20000,
        registrations: arrayUnion(new Date().toISOString())
      }); alert('ƒêƒÉng k√Ω th√†nh c√¥ng');
    });
    async function buyProduct(pid) {
      const prodRef = doc(db,'products',pid);
      const prodSnap = await getDoc(prodRef); const prod = prodSnap.data();
      if (state.walletBalance < prod.price) return alert('V√≠ kh√¥ng ƒë·ªß');
      await updateDoc(doc(db,'users',currentUsername),{
        walletBalance: state.walletBalance-prod.price,
        userNFT: arrayUnion({ id: pid, name: prod.name, price: prod.price })
      });
      await updateDoc(prodRef,{ status:'owned', owner:currentUsername }); alert('Mua th√†nh c√¥ng');
    }
    // N·∫°p & r√∫t modal
    document.getElementById('btnDeposit').addEventListener('click',() => depositModal.classList.add('show'));
    closeDeposit.addEventListener('click',() => depositModal.classList.remove('show'));
    confirmDeposit.addEventListener('click',async()=>{
      const amt=parseInt(inputDeposit.value);
      if (amt>0) await updateDoc(doc(db,'users',currentUsername),{
        walletBalance: state.walletBalance+amt,
        walletHistory: arrayUnion({ type:'deposit', amount:amt, date:new Date().toISOString() })
      }); depositModal.classList.remove('show');
    });
    document.getElementById('btnWithdraw').addEventListener('click',() => withdrawModal.classList.add('show'));
    closeWithdraw.addEventListener('click',() => withdrawModal.classList.remove('show'));
    confirmWithdraw.addEventListener('click',async()=>{
      const amt=parseInt(inputWithdraw.value);
      if (state.walletBalance<amt) return alert('V√≠ kh√¥ng ƒë·ªß');
      await updateDoc(doc(db,'users',currentUsername),{
        walletBalance: state.walletBalance-amt,
        walletHistory: arrayUnion({ type:'withdraw', amount:amt, date:new Date().toISOString() })
      }); withdrawModal.classList.remove('show');
    });

    function updateUI() {
      renderSessions(state.registrations);
      walletBalanceEl.innerText = state.walletBalance;
      walletHistoryEl.innerHTML = '';
      (state.walletHistory||[]).forEach(h=>{
        const li=document.createElement('li');
        li.textContent=`${h.type} ${h.amount} - ${new Date(h.date).toLocaleString('vi-VN')}`;
        walletHistoryEl.appendChild(li);
      });
      countRegs.innerText = (state.registrations||[]).length;
      countNFT.innerText = (state.userNFT||[]).length;
    }
  </script>
</body>
</html>
